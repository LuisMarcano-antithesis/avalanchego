name: Build and Push Docker Image

on:
  push:
    branches:
      - master  # Change this to your main branch name

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Login to GAR
      uses: docker/login-action@v3
      env: 
        REGISTRY: us-central1-docker.pkg.dev
      with:
        registry: ${{ env.REGISTRY }}
        username: _json_key
        password: ${{ secrets.ANTITHESIS_GAR_JSON_KEY }}
    
    - name: Build, tag, and push the avalanche image to Antithesis registry
      id: build-avalanche-image
      env: 
        REGISTRY: us-central1-docker.pkg.dev
        REPOSITORY: molten-verve-216720/avalanche-repository
        IMAGE_TAG: lm-testing
        IMAGE_NAME: avalanche-node
      run: |
        docker build --build-arg="RACE_FLAG=-r" -t $REGISTRY/$REPOSITORY/$IMAGE_NAME:$IMAGE_TAG -f ./Dockerfile.antithesis .

        echo "Pushing image to Antithesis..."
        docker push $REGISTRY/$REPOSITORY/$IMAGE_NAME --all-tags
        echo "name=image::$REGISTRY/$REPOSITORY/$IMAGE_NAME:$IMAGE_TAG" >> $GITHUB_OUTPUT
